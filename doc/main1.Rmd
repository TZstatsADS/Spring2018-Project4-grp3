---
title: "Project 4"
output: html_notebook
---

load packages
```{r}
library(reshape2)
```


# Step 1: Load Data
```{r}
movie_train_raw <- read.csv('../data/data_sample/eachmovie_sample/data_train.csv',header = T)
movie_test_raw <- read.csv('../data/data_sample/eachmovie_sample/data_test.csv',header = T)
MS_train_raw <- read.csv('../data/data_sample/MS_sample/data_train.csv',header = T)
MS_test_raw <- read.csv('../data/data_sample/MS_sample/data_test.csv',header = T)
```

## Reshape Data
```{r}

# ms data
source('../lib/preprocess.R')
## load processed data
load('../output/ms_train.RData')
load('../output/ms_test.RData')

# movie data
## train
dcast_train <- dcast(movie_train_raw, User~Movie)
rownames(dcast_train) <- dcast_train$User
movie_train <- dcast_train[,-1]
## test
dcast_test <- dcast(movie_test_raw, User~Movie)
rownames(dcast_test) <- dcast_test$User
movie_test <- dcast_test[,-1]
## save file
savefile = FALSE
if(savefile == TRUE) save(movie_train,movie_test, file = '../output/movie_wide.RData')
load(../output/movie_wide.RData)
```

# Step 2: Compute Similarity (weight)
## Vector Similarity
### Movie data
```{r}
# load vector similarity function
source('../lib/mat_weight.R')

# whether run vector similarity and whether save csv file
run.vec = FALSE
save.rd = FALSE
movie_vec_train <- mat_weight(data = movie_train_raw, 
                              run.vec = run.vec,
                              run.msd = FALSE)
movie_vec_test <- mat_weight(data = movie_test_raw, 
                             run.vec = run.vec,
                             run.msd = FALSE)

# save output in RData
if(save.rd == TRUE) save(movie_vec_train, movie_vec_test, file = 'movie_vec.RData')

# load output data
load('movie_vec.RData')
load('movie_vec.RData')
```

### MS data
```{r}
# whether run vector similarity and whether save csv file
run.vec = FALSE
save.rd = FALSE
ms_vec_train <- mat_weight(data = ms_train, 
                           run.vec = run.vec,
                           run.msd = FALSE)
ms_vec_test <- mat_weight(data = ms_test, 
                          run.vec = run.vec,
                          run.msd = FALSE)
# save output in RData
if(save.rd == TRUE) save(ms_vec_train, ms_vec_test, file = 'ms_vec.RData')

# load output data
load('movie_vec.RData')
load('movie_vec.RData')

```

## Mean Sqaure Difference
### Movie data
```{r}
# whether run vector similarity and whether save csv file
run.msd = FALSE
save.rd = FALSE
movie_msd_train <- mat_weight(data = movie_train_raw, 
                              run.vec = FALSE,
                              run.msd = run.msd)
movie_msd_test <- mat_weight(data = movie_test_raw, 
                             run.vec = FALSE,
                             run.msd = run.msd)

# save output in RData
if(save.rd == TRUE) save(movie_msd_train, movie_msd_test, file = 'movie_vec.RData')

# load output data
load('movie_vec.RData')
load('movie_vec.RData')

```

### MS data
```{r}
run.msd = FALSE
save.rd = FALSE
ms_msd_train <- mat_weight(data = ms_train, 
                           run.vec = FALSE,
                           run.msd = run.msd)
ms_msd_test <- mat_weight(data = ms_test, 
                          run.vec = FALSE,
                          run.msd = run.msd)
# save output in RData
if(save.rd == TRUE) save(ms_msd_train, ms_msd_test, file = 'ms_vec.RData')

# load output data
load('movie_vec.RData')
load('movie_vec.RData')
```

## Simrank (movie)
Note: simrank method is written in python
```{r}
# read in the simrank weight

# Sace weight in output
```

# Step 3: Cross validate parameters for different selecting neighbor methods
## Weight Threshold
```{r}

```

## Best-n-estimators
```{r}

```

## Combine
```{r}

```

# Step 4: Prediction & Evaluation
## MAE
### MS Data
```{r}

```

## Movie Data
```{r}

```

## Rank Score
### MS Data
```{r}

```

### Movie Data
```{r}

```

# Step 5: Model-based Algorithm
## Clustering (MS Dataset)
### Cross Validating the cluster model to find best cluster number C
```{r}
source("../lib/cluster_model.R")

preprocess_for_cluster(preprocess.train = F, preprocess.test = F, reshape.train = F, reshape.test = F)

load("../output/ms_train_wide.RData")
load("../output/ms_test_wide.RData")

list_of_items <- names(train[,-1])

cross.validate.model.clustering <- F
if(cross.validate.model.clustering){
  r <- c()
  parameters <- c(4,5,6,7,8)
  for(par in parameters){
    trained.cluster.model <- train.cluster.model(train, C = par)
    g <- trained.cluster.model$gamma_array
    m <- trained.cluster.model$mu
    p <- trained.cluster.model$pi_mat
    testing <- test.cluster.model(test, gamma_array = g, mu = m, pi_mat = p, list_of_items = list_of_items)
    r <- c(r, testing$r)
    print(paste("For number of clusters equal to:", par, "Rank score:", testing$r))
  }
  
  t <- matrix(NA, ncol = length(parameters), nrow = 2)
  t[1,] <- parameters
  t[2,] <- r
  rownames(t) <- c("C", "Rank Score")
  save(t, file = "../output/cv_cluster_rank_score.Rdata")
}

load("../output/cv_cluster_rank_score.Rdata")
print(t)
best.C <- as.numeric(t[1, which.max(t[2,])])
best.rank.score <- as.numeric(max(t[2,]))
print(paste("The best cluster number is:", best.C, ". Rank score is:", best.rank.score))

```

# Step 6: Prediction & Evaluation
## MAE
```{r}

```

## Rank Score
```{r}

```

